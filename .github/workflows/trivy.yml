# Copyright (c) 2021-2023 Contributors to the Eclipse Foundation

# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.

# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0.

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

# SPDX-License-Identifier: Apache-2.0
---

# Depending on the location of your Docker container
# you need to change the path to the specific Docker registry.
#
name: "Trivy"

on:
  push:
    branches: [main, development]
  # pull_request:
  # The branches below must be a subset of the branches above
  # branches: [ main, develop ]
  # paths-ignore:
  #   - "**/*.md"
  #   - "**/*.txt"
  schedule:
    # Once a day
    - cron: "0 0 * * *"
  workflow_dispatch:
  # Trigger manually

jobs:
  analyze-config:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@0.11.2
        with:
          scan-type: "config"
          # ignore-unfixed: true
          exit-code: "1"
          hide-progress: false
          format: "sarif"
          output: "trivy-results1.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results1.sarif"
#
#  analyze-managed-identity-wallet-service:
#    runs-on: ubuntu-latest
#    if: github.ref == 'refs/heads/main'
#    permissions:
#      actions: read
#      contents: read
#      security-events: write
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#
#      # It's also possible to scan your private registry with Trivy's built-in image scan.
#      # All you have to do is set ENV vars.
#      # Docker Hub needs TRIVY_USERNAME and TRIVY_PASSWORD.
#      # You don't need to set ENV vars when downloading from a public repository.
#      # For public images, no ENV vars must be set.
#      - name: Run Trivy vulnerability scanner
#        if: always()
#        uses: aquasecurity/trivy-action@0.11.2
#        with:
#          # Path to Docker image
#          image-ref: "ghcr.io/catenax-ng/tx-managed-identity-wallets_service:latest"
#          format: "sarif"
#          output: "trivy-results3.sarif"
#          exit-code: "1"
#          severity: "CRITICAL,HIGH"
#
#      - name: Upload Trivy scan results to GitHub Security tab
#        if: always()
#        uses: github/codeql-action/upload-sarif@v2
#        with:
#          sarif_file: "trivy-results3.sarif"
#
#  analyze-managed-identity-wallet-service-development:
#    runs-on: ubuntu-latest
#    if: github.ref == 'refs/heads/development'
#    permissions:
#      actions: read
#      contents: read
#      security-events: write
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#
#      # It's also possible to scan your private registry with Trivy's built-in image scan.
#      # All you have to do is set ENV vars.
#      # Docker Hub needs TRIVY_USERNAME and TRIVY_PASSWORD.
#      # You don't need to set ENV vars when downloading from a public repository.
#      # For public images, no ENV vars must be set.
#      - name: Run Trivy vulnerability scanner
#        if: always()
#        uses: aquasecurity/trivy-action@0.11.2
#        with:
#          # Path to Docker image
#          image-ref: "ghcr.io/catenax-ng/tx-managed-identity-wallets_service:latest-develop"
#          format: "sarif"
#          output: "trivy-results3.sarif"
#          exit-code: "1"
#          severity: "CRITICAL,HIGH"
#
#      - name: Upload Trivy scan results to GitHub Security tab
#        if: always()
#        uses: github/codeql-action/upload-sarif@v2
#        with:
#          sarif_file: "trivy-results3.sarif"
